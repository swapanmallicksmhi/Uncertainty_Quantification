#!/bin/bash
#SBATCH --cpus-per-task=1
#SBATCH --error=Fetch_CARRA2.log
#SBATCH --output=Fetch_CARRA2.log
#SBATCH --job-name=Fetch_CARRA2
#SBATCH --ntasks=1
#SBATCH --mem=80GB
#SBATCH --qos=nf
#SBATCH --time=24:00:00

module load eclib
module load python3

export MARS_MULTITARGET_STRICT_FORMAT=1
DDIR=/scratch/swe4281/DDPM_DATA/CARR2DYN/DATA_JAN19  #
SCRDIR=${PWD}
mkdir -p ${DDIR}

cd $DDIR || { echo "Could cd to $DDIR" ; exit ; }

DATE1=20190101
DATE2=20190110

# Make list of dates for the MARS retrieve
DATES=""
YMD=$DATE1
while (( "$YMD" <= "$DATE2" ));do
    if [[ $YMD == $DATE1 ]];then
	DATES="$YMD"
    else
	DATES=$DATES"/$YMD"
    fi
    YMD=$(newdate -D $YMD +1)
done

cat > mars_retrieve11.dat <<EOF
RETRIEVE,
 class=rr,
 date=${DATES},
 expver=prod,
 levtype=sfc,
 origin=no-ar-pa,
 param=167,
 stream=oper,
 time=00/06/12/18,
 type=an,
 target="$DDIR/CARRA2_t2m_[DATE].grib"
EOF

mars < mars_retrieve11.dat
echo 'Fetch complite'
module load conda
conda activate ddenv_v2
python3 ${SCRDIR}/grib2nc_SURF.py ${DDIR}  ./
exit 0
